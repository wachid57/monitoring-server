import{r as t,B as d,A as m,z as u,j as s,C as U}from"./index-CJWZi9CB.js";import{D as ie,X as ce,a as de,_ as me,b as ue,z as V}from"./index.esm-CBP19pFL.js";import{P as he}from"./PageContainer-BR_WMDrZ.js";import{B as pe}from"./Breadcrumb-DR6zDa-i.js";import{C as xe}from"./Card-BdzGKbvD.js";import{C as je}from"./CardContent-B4ITIunY.js";import{S as E}from"./Stack-C8hAk-Ua.js";import{B as W}from"./Box-B21Vn3Wr.js";import{T as l}from"./TextField-ZPSYDyyk.js";import{I as fe}from"./InputAdornment-DP5E7Axe.js";import{B as h}from"./Button-BH1WbAiu.js";import{A as v}from"./Alert-NqiMgJWO.js";import{C as P}from"./CircularProgress-DjzG6_YG.js";import{T as ge}from"./TableContainer-C29JBPns.js";import{P as Ce}from"./Paper-Dk0UhltF.js";import{T as ve,d as ye,b as F,c as a,a as be}from"./TableRow-BlqcCBcb.js";import{T as A}from"./Typography-DW8TAfFy.js";import{C as R}from"./Chip-DQyB0PyW.js";import{I as D}from"./IconButton-Cf6Oa_Gi.js";import{a as N,b as B}from"./DialogContent-iZlfiihu.js";import{D as I}from"./DialogTitle-fL9kXoX8.js";import{D as O}from"./DialogActions-WyzZcgZE.js";import"./Grid2-TKUllLdh.js";import"./composeClasses-CkcSq-l_.js";import"./index-BwqtTtay.js";import"./useSlotProps-Dmx4i6VU.js";import"./Link-DrUusogV.js";import"./createStack-B05ZxkoV.js";import"./useSlot-BJnJs1tW.js";import"./FormControl-CoJ51_a0.js";import"./utils-DoM3o7-Q.js";import"./useFormControl-D8zMB56u.js";import"./isMuiElement-DUOjtQlD.js";import"./useId-5Do1p0JB.js";import"./formControlState-Dq1zat_P.js";import"./Select-BdS4d3Pw.js";import"./Popover-C4QiusQk.js";import"./isHostComponent-DVu5iVWx.js";import"./Modal-BmV9fUd8.js";import"./getReactNodeRef-CxaND9dZ.js";import"./ownerWindow-CPegdbNg.js";import"./createChainedFunction-BO_9K8Jh.js";import"./utils-C-EoFTAL.js";import"./Portal-BXG2mGLy.js";import"./debounce-Be36O1Ab.js";import"./Grow-rhCcvyQJ.js";import"./List-CPHbMiuQ.js";import"./useControlled-Cuh16IWT.js";import"./resolveProps-CxWqPvcr.js";import"./Close-4pq8Nglm.js";const we=[{to:"/",title:"Home"},{title:"Admin"},{title:"Users"},{title:"List Users"}],vs=()=>{var q,Q,Y,Z;const[ee,_]=t.useState([]),[se,G]=t.useState(!1),[H,i]=t.useState(""),[g,re]=t.useState(""),[p,y]=t.useState({open:!1,user:null}),[te,b]=t.useState(!1),[o,x]=t.useState({username:"",email:"",name:"",password:"",role:"User"}),[J,ae]=t.useState([]),[X,j]=t.useState(""),[L,K]=t.useState(!1),[oe,w]=t.useState(!1),[f,S]=t.useState(null),[n,C]=t.useState({username:"",email:"",name:"",role:""}),[M,k]=t.useState(!1),z=async()=>{G(!0),i("");try{console.log("Fetching users from:",d+m+"/users"),console.log("Auth headers:",u());const e=await fetch(d+m+"/users",{method:"GET",headers:u()});if(console.log("Response status:",e.status),e.status===401||e.status===403){console.log("Auth error, redirecting to login"),U({status:e.status});return}const r=await e.json();console.log("Response data:",r),e.ok?_(r.users||r||[]):i(r.error||r.message||"Gagal mengambil data users")}catch(e){console.error("Fetch users error:",e),i("Terjadi kesalahan saat mengambil data users")}finally{G(!1)}},ne=async e=>{try{const r=await fetch(d+m+`/users/${e}`,{method:"DELETE",headers:u()});if(r.status===401||r.status===403){U({status:r.status});return}if(r.ok)_(c=>c.filter(T=>T.id!==e)),y({open:!1,user:null});else{const c=await r.json();i(c.error||c.message||"Gagal menghapus user")}}catch(r){console.error("Delete user error:",r),i("Terjadi kesalahan saat menghapus user")}},$=ee.filter(e=>{var c,T;const r=e.roles&&e.roles.length>0?e.roles[0].name||"":e.role||"";return((c=e.username)==null?void 0:c.toLowerCase().includes(g.toLowerCase()))||((T=e.email)==null?void 0:T.toLowerCase().includes(g.toLowerCase()))||r.toLowerCase().includes(g.toLowerCase())}),le=e=>{switch(e==null?void 0:e.toLowerCase()){case"administrator":case"admin":return"error";case"user":return"primary";case"moderator":return"warning";default:return"default"}};return t.useEffect(()=>{z(),(async()=>{try{const e=await fetch(d+m+"/admin/roles",{headers:u()});if(e.ok){const r=await e.json();ae(Array.isArray(r)?r:r.roles||[])}}catch(e){console.error("Failed to fetch roles",e)}})()},[]),s.jsxs(he,{title:"List Users",description:"Manage system users",children:[s.jsx(pe,{title:"List Users",items:we}),s.jsx(xe,{children:s.jsxs(je,{children:[s.jsxs(E,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:3,children:[s.jsx(W,{sx:{minWidth:300},children:s.jsx(l,{placeholder:"Search users...",value:g,onChange:e=>re(e.target.value),InputProps:{startAdornment:s.jsx(fe,{position:"start",children:s.jsx(ie,{size:20})})},fullWidth:!0})}),s.jsx(h,{variant:"contained",startIcon:s.jsx(ce,{}),color:"primary",onClick:()=>{b(!0),j("")},sx:{width:225},children:"Add New User"})]}),H&&s.jsx(v,{severity:"error",sx:{mb:3},children:H}),se?s.jsx(W,{display:"flex",justifyContent:"center",py:4,children:s.jsx(P,{})}):s.jsx(ge,{component:Ce,children:s.jsxs(ve,{children:[s.jsx(ye,{children:s.jsxs(F,{children:[s.jsx(a,{children:"User"}),s.jsx(a,{children:"Email"}),s.jsx(a,{children:"Role"}),s.jsx(a,{children:"Native"}),s.jsx(a,{children:"Status"}),s.jsx(a,{children:"Created"}),s.jsx(a,{align:"center",children:"Actions"})]})}),s.jsx(be,{children:$.length===0?s.jsx(F,{children:s.jsx(a,{colSpan:7,align:"center",sx:{py:4},children:s.jsx(A,{variant:"body1",color:"textSecondary",children:g?"No users found matching your search":"No users found"})})}):$.map(e=>s.jsxs(F,{children:[s.jsx(a,{children:s.jsxs(E,{direction:"row",alignItems:"center",spacing:2,children:[s.jsx(de,{size:32}),s.jsxs(W,{children:[s.jsx(A,{variant:"subtitle2",fontWeight:600,children:e.username}),s.jsxs(A,{variant:"caption",color:"textSecondary",children:["ID: ",e.id]})]})]})}),s.jsx(a,{children:e.email||"-"}),s.jsx(a,{children:(()=>{const r=e.roles&&e.roles.length>0?e.roles[0].name||"User":e.role||"User";return s.jsx(R,{size:"small",label:r,color:le(r)})})()}),s.jsx(a,{children:e.native?s.jsx(R,{label:"native",size:"small",color:"secondary"}):"-"}),s.jsx(a,{children:s.jsx(R,{label:"Active",color:"success",size:"small"})}),s.jsx(a,{children:e.created_at?new Date(e.created_at).toLocaleDateString():"-"}),s.jsx(a,{align:"center",children:s.jsxs(E,{direction:"row",spacing:1,justifyContent:"center",children:[s.jsx(D,{size:"small",color:"primary",children:s.jsx(me,{size:16})}),s.jsx(D,{size:"small",color:"warning",title:"Edit user",onClick:()=>{const r=e.roles&&e.roles.length>0?e.roles[0].name||"User":e.role||"User";S(e),C({username:e.username||"",email:e.email||"",name:e.name||"",role:r||""}),w(!0)},children:s.jsx(ue,{size:16})}),s.jsx("span",{children:e.native?s.jsx(D,{size:"small",color:"inherit",disabled:!0,title:"Native user cannot be deleted",children:s.jsx(V,{size:16})}):s.jsx(D,{size:"small",color:"error",onClick:()=>y({open:!0,user:e}),children:s.jsx(V,{size:16})})})]})})]},e.id))})]})})]})}),s.jsxs(N,{open:p.open,onClose:()=>y({open:!1,user:null}),children:[s.jsx(I,{children:"Confirm Delete"}),s.jsx(B,{children:(q=p.user)!=null&&q.native?s.jsxs(v,{severity:"warning",children:['Native user "',(Q=p.user)==null?void 0:Q.username,'" cannot be deleted.']}):s.jsxs(A,{children:['Are you sure you want to delete user "',(Y=p.user)==null?void 0:Y.username,'"? This action cannot be undone.']})}),s.jsxs(O,{children:[s.jsx(h,{onClick:()=>y({open:!1,user:null}),color:"primary",children:"Cancel"}),s.jsx(h,{onClick:()=>{var e;return ne((e=p.user)==null?void 0:e.id)},color:"error",variant:"contained",disabled:(Z=p.user)==null?void 0:Z.native,children:"Delete"})]})]}),s.jsxs(N,{open:te,onClose:()=>{b(!1),j("")},fullWidth:!0,maxWidth:"sm",children:[s.jsx(I,{children:"Add New User"}),s.jsxs(B,{children:[X&&s.jsx(v,{severity:"error",sx:{mb:2},children:X}),s.jsx(l,{label:"Username",fullWidth:!0,margin:"dense",value:o.username,onChange:e=>x({...o,username:e.target.value})}),s.jsx(l,{label:"Email",fullWidth:!0,margin:"dense",value:o.email,onChange:e=>x({...o,email:e.target.value})}),s.jsx(l,{label:"Full name",fullWidth:!0,margin:"dense",value:o.name,onChange:e=>x({...o,name:e.target.value})}),s.jsx(l,{label:"Password",type:"password",fullWidth:!0,margin:"dense",value:o.password,onChange:e=>x({...o,password:e.target.value})}),s.jsxs(l,{select:!0,SelectProps:{native:!0},label:"Role",fullWidth:!0,margin:"dense",value:o.role,onChange:e=>x({...o,role:e.target.value}),helperText:"Choose a role",children:[s.jsx("option",{value:"",children:"Select role"}),J.map(e=>s.jsx("option",{value:e.name,children:e.name},e.id))]})]}),s.jsxs(O,{children:[s.jsx(h,{onClick:()=>b(!1),disabled:L,children:"Cancel"}),s.jsx(h,{variant:"contained",color:"primary",onClick:async()=>{if(j(""),!o.username||!o.password){j("Username and password are required");return}K(!0);try{const e=await fetch(d+m+"/users",{method:"POST",headers:{"Content-Type":"application/json",...u()},body:JSON.stringify(o)});if(e.status===401||e.status===403){U({status:e.status});return}const r=await e.json();e.ok?(z(),b(!1),x({username:"",email:"",name:"",password:"",role:"User"})):j(r.error||r.message||"Failed to create user (role assignment may have failed)")}catch(e){console.error("Create user error:",e),j("Failed to create user")}finally{K(!1)}},disabled:L,children:L?s.jsx(P,{size:20}):"Create"})]})]}),s.jsxs(N,{open:oe,onClose:()=>{w(!1),S(null)},fullWidth:!0,maxWidth:"sm",children:[s.jsx(I,{children:"Edit User"}),s.jsxs(B,{children:[s.jsxs(E,{spacing:2,mt:1,children:[s.jsx(l,{label:"Username",value:n.username,onChange:e=>C({...n,username:e.target.value}),fullWidth:!0}),s.jsx(l,{label:"Email",value:n.email,onChange:e=>C({...n,email:e.target.value}),fullWidth:!0}),s.jsx(l,{label:"Full name",value:n.name,onChange:e=>C({...n,name:e.target.value}),fullWidth:!0}),s.jsxs(l,{select:!0,SelectProps:{native:!0},label:"Role",fullWidth:!0,value:n.role,onChange:e=>C({...n,role:e.target.value}),helperText:"Choose a role",children:[s.jsx("option",{value:"",children:"Select role"}),J.map(e=>s.jsx("option",{value:e.name,children:e.name},e.id))]})]}),(f==null?void 0:f.native)&&s.jsx(v,{severity:"info",sx:{mt:2},children:"This is a native user. Some fields may be restricted by the backend."}),s.jsx(v,{severity:"info",sx:{mt:2},children:"To change password, use the Change Password feature."})]}),s.jsxs(O,{children:[s.jsx(h,{onClick:()=>{w(!1),S(null)},disabled:M,children:"Cancel"}),s.jsx(h,{variant:"contained",onClick:async()=>{if(f){k(!0);try{const e=await fetch(d+m+`/users/${f.id}`,{method:"PUT",headers:{"Content-Type":"application/json",...u()},body:JSON.stringify({username:n.username,email:n.email,name:n.name})});if(e.status===401||e.status===403){U({status:e.status});return}const r=await e.json();if(!e.ok){i(r.error||r.message||"Failed to update user"),k(!1);return}n.role&&await fetch(d+m+"/users/roles/users",{method:"POST",headers:{"Content-Type":"application/json",...u()},body:JSON.stringify({user_id:f.id,role_name:n.role})}),w(!1),S(null),z()}catch(e){console.error("Edit user error",e),i("Failed to update user")}finally{k(!1)}}},children:M?s.jsx(P,{size:18}):"Save Changes"})]})]})]})};export{vs as default};
